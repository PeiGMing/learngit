<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cabo 计分板</title>
    <style>
        /* 保留原始样式 */
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f0f0f0;
            backdrop-filter: blur(8px);
        }

        .container {
            display: flex;
            width: 80%;
            max-width: 1200px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .scoreboard,
        .round-scores {
            padding: 25px;
            background-color: #fff;
            border-radius: 15px;
        }

        .player-score {
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-name {
            margin-right: 10px;
            font-weight: bold;
            color: #333;
        }

        input,
        button {
            border-radius: 8px;
            border: 1px solid #ccc;
            padding: 10px;
            margin: 5px;
            transition: all 0.3s ease;
        }

        button {
            background-color: #007AFF;
            color: white;
            border: none;
        }

        button:hover {
            background-color: #0051BA;
        }

        .loser {
            background-color: #FF4F4F;
            color: white;
        }

        .near-loser {
            background-color: #FFC700;
            color: black;
            animation: flash 1s infinite;
            /* 添加闪烁动画 */
        }

        table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }

        th,
        td {
            border: 1px solid #E1E1E1;
            padding: 12px;
            text-align: center;
            background-color: #fff;
        }

        th {
            background-color: #F2F2F2;
            font-weight: bold;
            color: #333;
        }

        @keyframes flash {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="scoreboard">
            <h1>Cabo 计分板</h1>
            <div id="gameInfo">
                <p id="currentGame">GAME：1 | ROUND：0</p>
            </div>
            <div id="playerList">
                <!-- 玩家输入和得分容器将由 JavaScript 在这里添加 -->
            </div>
            <div id="addPlayerControls">
                <input type="text" id="newPlayerName" placeholder="输入玩家名称">
                <button onclick="addPlayer()">添加玩家</button>
            </div>
            <div>
                <button onclick="finishRound()">结束回合</button>
                <button onclick="restartGame()" class="hidden" id="restartGameBtn">新游戏</button>
            </div>
        </div>
        <div class="round-scores" id="roundScoresHistory">
            <!-- 回合得分历史将在这里显示 -->
        </div>
    </div>
    <script>
        let players = {};
        let currentGame = 1;
        let gameActive = true;
        let roundCount = 0;
        let currentTable;

        function addPlayer() {
            if (gameActive) {
                const playerList = document.getElementById('playerList');
                const newPlayerName = document.getElementById('newPlayerName').value.trim();
                if (newPlayerName && !players.hasOwnProperty(newPlayerName)) {
                    players[newPlayerName] = 0;
                    const playerDiv = document.createElement('div');
                    playerDiv.classList.add('player-score');
                    const playerNameSpan = document.createElement('span');
                    playerNameSpan.classList.add('player-name');
                    playerNameSpan.textContent = newPlayerName;
                    playerDiv.appendChild(playerNameSpan);
                    const scoreInput = document.createElement('input');
                    scoreInput.type = 'number';
                    scoreInput.min = '0';
                    scoreInput.id = 'input_' + newPlayerName;
                    playerDiv.appendChild(scoreInput);
                    const totalScoreSpan = document.createElement('span');
                    totalScoreSpan.textContent = '0';
                    totalScoreSpan.id = 'total_' + newPlayerName;
                    playerDiv.appendChild(totalScoreSpan);
                    playerList.appendChild(playerDiv);
                    document.getElementById('newPlayerName').value = '';
                } else {
                    alert('该玩家已存在。');
                }
            } else {
                alert('游戏已开始，结束此游戏可添加玩家。');
            }
        }

        function finishRound() {
            const roundScoresContainer = document.getElementById('roundScoresHistory');
            if (!currentTable) {
                currentTable = createGameTable();
            }

            const roundRow = currentTable.querySelector('tbody').insertRow();
            roundRow.insertCell(0).textContent = `ROUND ${++roundCount}`;

            for (const playerName in players) {
                const scoreInput = document.getElementById('input_' + playerName);
                const roundScore = parseInt(scoreInput.value) || 0;
                players[playerName] += roundScore;
                document.getElementById('total_' + playerName).textContent = players[playerName];
                const scoreCell = roundRow.insertCell();
                scoreCell.textContent = roundScore;
            }

            updateTotalScores();
            updateGameInfo();
            gameActive = false;
            document.getElementById('addPlayerControls').classList.add('hidden');
            document.getElementById('restartGameBtn').classList.remove('hidden');

            checkLosers();
        }

        function createGameTable() {
            const roundScoresContainer = document.getElementById('roundScoresHistory');
            const gameTable = document.createElement('table');
            gameTable.innerHTML = `
                <thead>
                    <tr><th colspan="${Object.keys(players).length + 1}">GAME ${currentGame}</th></tr>
                    <tr><th>ROUND</th>${Object.keys(players).map(name => `<th>${name}</th>`).join('')}</tr>
                </thead>
                <tbody>
            `;
            roundScoresContainer.appendChild(gameTable);
            return gameTable;
        }

        function updateTotalScores() {
            const tbody = currentTable.querySelector('tbody');
            while (tbody.rows.length > roundCount) {
                tbody.deleteRow(tbody.rows.length - 2);
            }
            const totalRow = tbody.insertRow();
            totalRow.insertCell(0).textContent = "总分";
            for (const playerName in players) {
                const totalCell = totalRow.insertCell();
                totalCell.textContent = players[playerName];
            }
        }

        function updateGameInfo() {
            document.getElementById('currentGame').textContent = `GAME：${currentGame} | ROUND：${roundCount}`;
        }

        function restartGame() {
            currentGame++;
            roundCount = 0;
            for (const playerName in players) {
                console.log(playerName);
                const playerDiv = document.getElementById(`input_${playerName}`).parentNode;
                const playerNameElement = playerDiv.querySelector('.player-name');
                if (players[playerName] < 100) {
                    players[playerName] = 0;
                    document.getElementById('total_' + playerName).textContent = '0';
                    document.getElementById('input_' + playerName).value = '0';

                    playerNameElement.classList.remove('near-loser');
                    document.getElementById('input_' + playerName).classList.remove('near-loser');
                    document.getElementById('total_' + playerName).classList.remove('near-loser');
                }

                if (players[playerName] >= 100) {
                    players[playerName] = 0;
                    document.getElementById('total_' + playerName).textContent = '0';
                    document.getElementById('input_' + playerName).value = '0';

                    playerNameElement.classList.remove('loser');
                    document.getElementById('input_' + playerName).classList.remove('loser');
                    document.getElementById('total_' + playerName).classList.remove('loser');
                }
            }
            updateGameInfo();
            document.getElementById('addPlayerControls').classList.remove('hidden');
            document.getElementById('restartGameBtn').classList.add('hidden');
            gameActive = true;
            currentTable = null;
        }

        function checkLosers() {
            const losingScore = 100;
            const warningScore = Math.floor(losingScore * 0.85);

            for (const playerName in players) {
                const totalScore = players[playerName];
                const totalElement = document.getElementById(`total_${playerName}`);
                const playerDiv = document.getElementById(`input_${playerName}`).parentNode;
                const playerNameElement = playerDiv.querySelector('.player-name');
                console.log(playerNameElement);

                if (totalScore >= losingScore) {
                    // 达到输分：直接红色，不闪烁
                    totalElement.classList.add('loser');
                    playerNameElement.classList.add('loser');
                    totalElement.classList.remove('near-loser');
                    playerNameElement.classList.remove('near-loser');
                } else if (totalScore >= warningScore) {
                    // 达到85%输分：闪烁黄色
                    totalElement.classList.add('near-loser');
                    playerNameElement.classList.add('near-loser');
                } else {
                    // 恢复正常状态
                    totalElement.classList.remove('loser', 'near-loser');
                    playerNameElement.classList.remove('loser', 'near-loser');
                }
            }
        }
    </script>
</body>

</html>